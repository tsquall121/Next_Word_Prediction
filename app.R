#
# This is a Shiny web application. You can run the application by clicking
# the 'Run App' button above.
#
# Find out more about building applications with Shiny here:
#
#    http://shiny.rstudio.com/
#

library(shiny)
library(shinythemes)
library(markdown)
library(dplyr)
library(stringr)
library(tm)

# Define UI for application that draws a histogram
ui <- navbarPage("Next Word Prediction",
                 theme = shinytheme("readable"),
                 tabPanel("Instructions",
                          h3("How to Use Next Word Prediction"),
                          br(),
                          div("This APP uses a n-gram text prediction algorithm to 
                          predict the next word(s) based on text entered by a user.",
                              br(),
                              br(),
                              "You have to type at least one word in the 'Enter Word(s)' box.
                              Please allow a few seconds for the output to appear.",
                              br(),
                              br(),
                              "In addition, you can use the slider to choose up to three next
                            word predictions. The top three predictions of next words will show accordingly.")),
                 tabPanel("APP",
                          fluidPage(
                              titlePanel("Home"),
                              sidebarLayout(
                                  sidebarPanel(
                                      textInput("userInput",
                                                "Enter Word(s):",
                                                value =  "",
                                                placeholder = "Enter text here"),
                                      br(),
                                      sliderInput("numPredictions", "Number of Predictions:",
                                                  value = 1.0, min = 1.0, max = 3.0, step = 1.0)
                                  ),
                                  mainPanel(
                                      h4("Input Text"),
                                      verbatimTextOutput("userSentence"),
                                      br(),
                                      h4("Predicted Words"),
                                      verbatimTextOutput("prediction1"),
                                      verbatimTextOutput("prediction2"),
                                      verbatimTextOutput("prediction3")
                                  )
                              )
                          )
                 )
)



# load the n-gram frequencies (generated by "build-ngram-frequencies.R")
initialPrediction <- readRDS("startwordprediction.RData")
freq2ngram <- readRDS("bigram.RData")
freq3ngram <- readRDS("trigram.RData")
freq4ngram <- readRDS("quadgram.RData")


predictionMatch <- function(userInput, ngrams) {
    
    # quadgram (and higher)
    if (ngrams > 3) {
        userInput3 <- paste(userInput[length(userInput) - 2],
                            userInput[length(userInput) - 1],
                            userInput[length(userInput)])
        dataTokens <- freq4ngram %>% filter(variable == userInput3)
        ##dataTokens <- freq4ngram %>% filter(token == userInput3)
        if (nrow(dataTokens) >= 1) {
            return(dataTokens$outcome[1:3])
        }
        # backoff to trigram
        return(predictionMatch(userInput, ngrams - 1))
    }
    
    # trigram
    if (ngrams == 3) {
        userInput1 <- paste(userInput[length(userInput)-1], userInput[length(userInput)])
        dataTokens <- freq3ngram %>% filter(variable == userInput1)
        ##dataTokens <- freq3ngram %>% filter(token == userInput1)
        if (nrow(dataTokens) >= 1) {
            return(dataTokens$outcome[1:3])
        }
        # backoff to bigram
        return(predictionMatch(userInput, ngrams - 1))
    }
    
    # bigram (and lower)
    if (ngrams < 3) {
        userInput1 <- userInput[length(userInput)]
        dataTokens <- freq2ngram %>% filter(variable == userInput1)
        ##dataTokens <- freq2ngram %>% filter(token == userInput1)
        return(dataTokens$outcome[1:3])
        # backoff (1-gram not implemented for enhanced performance)
        # return(match_predict(userInput, ngrams - 1))
    }
    
    # unigram: not implemented to enhance performance
    return(NA)
}

cleaninput <- function(input){
    if(input == ""){
        return("")
    }
    input <- input %>% 
        stripWhitespace() %>% 
        str_to_lower() %>% 
        str_split(pattern = " ") %>% 
        unlist() 
    return(input)
}

predictNextWord <- function(input, word = 0) {
    input <- cleaninput(input)
    
    if (input[1] == "") {
        output <- initialPrediction
    } else if (length(input) == 1) {
        output <- predictionMatch(input, ngrams = 2)
    } else if (length(input) == 2) {
        output <- predictionMatch(input, ngrams = 3)
    } else if (length(input) > 2) {
        output <- predictionMatch(input, ngrams = 4)
    }
    
    if (word == 0) {
        return(output)
    } else if (word == 1) {
        return(output[1])
    } else if (word == 2) {
        return(output[2])
    } else if (word == 3) {
        return(output[3])
    }
    
}

server <- function(input, output) {
    
    # original sentence
    output$userSentence <- renderText({input$userInput});
    
    # reactive controls
    observe({
        numPredictions <- input$numPredictions
        if (numPredictions == 1) {
            output$prediction1 <- reactive({predictNextWord(input$userInput, 1)})
            output$prediction2 <- NULL
            output$prediction3 <- NULL
        } else if (numPredictions == 2) {
            output$prediction1 <- reactive({predictNextWord(input$userInput, 1)})
            output$prediction2 <- reactive({predictNextWord(input$userInput, 2)})
            output$prediction3 <- NULL
        } else if (numPredictions == 3) {
            output$prediction1 <- reactive({predictNextWord(input$userInput, 1)})
            output$prediction2 <- reactive({predictNextWord(input$userInput, 2)})
            output$prediction3 <- reactive({predictNextWord(input$userInput, 3)})
        }
    })
    
}

# Run the application 
shinyApp(ui = ui, server = server)
